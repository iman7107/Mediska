@using Mediska.Models;
@using Mediska.Models.Repository;
@{
    ViewBag.Title = "تکمیل سبد خرید";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    repProduct RepP = new repProduct();
    decimal TotalPrice = 0;
    decimal TotalOff = 0;
    int c = 0;

    List<cmplxProduct> ProductList = new List<cmplxProduct>();
    List<cmplxPackage> PackageList = new List<cmplxPackage>();
    List<clsCompeletCart> offCodeList = new List<clsCompeletCart>();
    if (Session["ShopCart"] != null)
    {
        List<int> cart = Session["ShopCart"] as List<int>;
        offCodeList = Session["OffCodeList"] as List<clsCompeletCart>;
        TotalOff = offCodeList?.Select(i => i.CompeletCartDetails).Sum(j => j.Select(g => g.FinalPrice).DefaultIfEmpty(0).Sum()) ?? 0;
        PackageList = RepP.GetPackagesByIDs(cart);
        var ProductIDs = PackageList.Select(i => i.packageProductID).Distinct().ToList();
        ProductList = RepP.GetProductsByIDs(ProductIDs);
        TotalPrice = PackageList.Sum(i => i.packagePrice);

        TotalPrice = TotalPrice - (TotalOff > 0 ? TotalPrice - TotalOff : 0);
    }
}
<style>
    .input-group {
        margin-bottom: 5px;
    }

    li::before {
        content: "•";
        color: red;
        display: inline-block;
        width: 1em;
        margin-left: -1em
    }

    label {
        width: 20%;
    }

</style>
<div class="container">
    <div class="basketpage_buy_div">
        تکمیل سبد خرید
        @if (Session["ShopCart"] != null)
        {
            <span class="basketpage_cart_count">@PackageList.Count</span>
        }
    </div>
    <div class="margin_top_20 margin_bottom_20">
        <div id="accordion">
            @foreach (var product in ProductList)
            {
                var MyPackageList = PackageList.Where(i => i.packageProductID == product.prdxtraProductID).ToList();
                var SumPrice = MyPackageList.Sum(i => i.packagePrice);
                var offCode = offCodeList?.Where(i => i.ProductID == product.ID).Select(i => i.OffCode).FirstOrDefault();

                var offCodeDetail = offCodeList?.Where(i => i.ProductID == product.ID).Select(i => i.CompeletCartDetails).FirstOrDefault();
                <div class="card">
                    <div class="card-header" id="heading_@product.prdxtraProductID">
                        <div class="display_flex">
                            <a href="/Home/ShowProduct/@product.prdxtraProductID"><img src="~/Content/image/Products/@product.prdxtraAvatarPhotoName" class="product_img_cart" /></a>
                            <button class="btn btn-link btn_product_title" data-toggle="collapse" data-target="#collapse_@product.prdxtraProductID" aria-expanded="true" aria-controls="collapse_@product.prdxtraProductID">
                                @product.prdxtraTitle
                            </button>
                            <span class="span_price span_price_sum">@SumPrice.ToString("N0") تومان</span>
                            @if (!string.IsNullOrEmpty(offCode))
                            {
                                <span class="span_price span_price_sum" style="margin-right:20px">کد تخفیف: @offCode</span>
                            }
                            <form action="/ShopCart/FinalCart" id="compeletCartForm" method="post">
                                <input type="hidden" name="finalCartList[@c].ProductID" value="@product.prdxtraProductID" />
                                <select id="customerList" name="finalCartList[@c].CustomerID" class="form-control" style="margin-right:10px;margin-left:20px">
                                    <option value="none" selected disabled>--انتخاب مرکز--</option>
                                    @foreach (var item in ViewBag.CustomerList)
                                    {
                                        <option value="@item.customerID">[@item.custgroupName]-[@(item.customerAddress.Length > 30 ? item.customerAddress.Substring(0, 30) + "...." : item.customerAddress)]</option>
                                    }
                                </select>
                            </form>

                            <a id="newCustomer" data-toggle="modal" href="#customerModal" class="btn btn-sm btn-primary" style="margin-right:20px">مرکز جدید</a>

                            @{
                                c++;
                            }
                        </div>
                    </div>
                    <div id="collapse_@product.prdxtraProductID" class="collapse show" aria-labelledby="heading_@product.prdxtraProductID" data-parent="#accordion">
                        <div class="card-body padding_right_30">

                            <table class="table table-hover table_shop_cart">
                                @foreach (var pack in MyPackageList)
                                {
                                    var finalPrice = offCodeDetail?.Where(i => i.PackageID == pack.ID).Select(i => i.FinalPrice).FirstOrDefault() ?? 0;

                                    <tr class="cursor_pointer data_row">
                                        <td data-id="@pack.ID" class="width_250">
                                            [@pack.ID] @pack.packageName
                                        </td>
                                        <td data-id="@pack.ID" class="width_150">
                                            <span class="font_15" style="@(finalPrice > 0 ? Html.Raw("color:#b0aeae;text-decoration:line-through"):Html.Raw(""))">@pack.packagePrice.ToString("N0") </span><span class="font_15">@(finalPrice > 0 ? finalPrice.ToString("N0") : "")</span><span class="span_tooman font_12">تومان</span>
                                        </td>
                                        <td>
                                        </td>
                                    </tr>
                                }
                            </table>
                        </div>
                    </div>
                </div>
            }
            <div class="container-full basketpage_cart_footer_div">
                <div class="basketpage_cart_footer_inner_div">
                    <span class="basketpage_cart_footer_sum_span">قابل پرداخت :</span>
                    <span class="basketpage_cart_footer_price_span" id="totalPrice">@TotalPrice.ToString("N0")</span>
                    <span class="basketpage_cart_footer_tooman_span"> تومـان</span>
                </div>
                <a href="#" id="compeletCart" class="btn btn-success">پرداخت</a>
            </div>
        </div>
    </div>
</div>


@foreach (var item in ProductList)
{
    <div class="modal licenseagreement"  >
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">

                    <h4 class="modal-title">
                        توافق نامه
                    </h4>
                </div>
                <div class="modal-body">
                    @{
                        
                        var arr = item.prdxtraLicenseAgreement.Split('•');
                        foreach (var items in arr)
                        {
                            <p style="text-align: justify;">@items</p>
                        }
                    }

                </div>
                <div class="modal-footer">
                    <a href="#" id="mybtnInsertCustomer" class="btn btn-danger" data-dismiss="modal" aria-hidden="true">
                        موافق
                    </a>
                </div>
            </div>
            </div>
    </div>
}

 <div class="modal" id="customerModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    ×
                </button>
                <h4 class="modal-title">
                    مرکز جدید
                </h4>
            </div>
            <form action="/ShopCart/InsertCustomer" id="insertCustomer" method="post">
                <div class="modal-body">
                    <div class="form-group">

                        <div class="input-group input-group-sm">
                            <label class="lbl">
                                نام مجموعه:
                            </label>
                            @Html.TextBox("customerCompanyName", null, new { @class = "form-control" })
                        </div>

                        <div class="input-group input-group-sm">
                            <label class="pb-1">
                                نام مدیر:
                            </label>
                            @Html.TextBox("customerManagerName", null, new { @class = "form-control" })
                        </div>

                        <div class="input-group input-group-sm">
                            <label class="pb-1">
                                نام خانوادگی:
                            </label>
                            @Html.TextBox("customerManagerFamily", null, new { @class = "form-control" })
                        </div>

                        <div class="input-group input-group-sm">
                            <label class="pb-1">
                                موبایل:
                            </label>
                            @Html.TextBox("customerManagerMobileNo", null, new { @class = "form-control" })
                        </div>

                        <div class="input-group input-group-sm">
                            <label class="pb-1">
                                کد ملی:
                            </label>
                            @Html.TextBox("customerMelliNo", null, new { @class = "form-control" })
                        </div>

                        <div class="input-group input-group-sm">
                            <label class="pb-1">
                                تاریخ تولد:
                            </label>
                            @Html.TextBox("customerBirthDate", null, new { @class = "form-control" })
                        </div>

                        <div class="input-group input-group-sm">
                            <label class="pb-1">
                                جنسیت:
                            </label>
                            <select class = "form-control" name="customerManagerGender">
                                <option value="1">مرد</option>
                                <option value="0">زن</option>
                            </select>
                        </div>

                        <div class="input-group input-group-sm">
                            <label class="pb-1">
                                گروه مشتری:
                            </label>
                            <select id="customerCustomerGroupID" name="customerCustomerGroupID">
                            </select>

                        </div>

                        <div class="input-group input-group-sm">
                            <label class="pb-1">
                                استان-شهر:
                            </label>
                            <select id="customerAreaID" name="customerAreaID">
                            </select>
                        </div>

                        <div class="input-group input-group-sm">
                            <label class="pb-1">
                                آدرس:
                            </label>
                            @Html.TextArea("customerAddress", null, new { @class = "form-control", rows = "4" })
                        </div>

                    </div>

                </div>
            </form>
            <div class="modal-footer">
                <a href="#" data-dismiss="modal" class="btn">بستن</a>
                <a href="#" id="btnInsertCustomer" class="btn btn-primary">
                    ذخیره
                </a>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="text/javascript">

        $(function () {


            $('.licenseagreement').modal(
                {
                    backdrop: 'static',
                    keyboard: false
                });
            $("#newCustomer").click(function () {
                jQuery.getJSON("/ShopCart/myAreaList/", { query: "" }, function (data) {
                    $("#customerAreaID").select2({
                        data: data,
                        dir: 'rtl',
                        width: '80%'
                    });
                });

                jQuery.getJSON("/ShopCart/myCustomerGroupList/", { }, function (data) {
                    $("#customerCustomerGroupID").select2({
                        data: data,
                        dir: 'rtl',
                        width: '80%'
                    });
                });
            });

            $("#compeletCart").click(function () {
                $.post("/ShopCart/FinalCart", $("#compeletCartForm").serialize(), function (data) {
                    showAlert("خطا", data.Message, "error");
                });
            });

            $("#btnInsertCustomer").click(function () {
                $.post("/ShopCart/InsertCustomer", $("#insertCustomer").serialize(), function (data) {
                    if (data.Message !== "") {
                        showAlert("خطا", data.Message, "error");
                    } else {
                        jQuery.getJSON("/ShopCart/myCustomerList/", {}, function (data) {
                            $("#customerList").find("option").remove();
                            $.each(data, function (i) {

                                var option = "<option value='" + data[i].customerID + "'>[" + data[i].custgroupName + "]-[" + (data[i].customerAddress.length > 30 ? data[i].customerAddress.substring(0, 30) + "...." : data[i].customerAddress ) +"]</option>";
                                $("#customerList").append(option);
                            });

                        });

                        $('#customerModal').modal('toggle');
                    }
                });
            });
        });

    </script>
}